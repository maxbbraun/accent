# Accent

Accent is a smart picture frame with a pop of color and noÂ cables. Read more about it [on Medium](https://accent.ink/info).

[![Accent](accent.gif)](https://accent.ink)

## Client

The Accent client uses the [PlatformIO Arduino toolchain](https://platformio.org) for the [Waveshare ESP32 board](https://www.waveshare.com/wiki/E-Paper_ESP32_Driver_Board). See the [client control flow](client/README.md) for a high-level overview of the client code.

To push the client code to the board:
1. Configure the [IDE](https://platformio.org/platformio-ide) or [CLI](https://platformio.org/install/cli) with [`platformio.ini`](client/platformio.ini).
2. Pick one display type via `build_flags` in [`platformio.ini`](client/platformio.ini):
   - [GDEW075Z09](https://www.e-paper-display.com/products_detail/productId=324.html)  (7.5" 640x384 3-color)
   - [GDEW075Z08](https://www.e-paper-display.com/products_detail/productId=457.html) (7.5" 800x480 3-color)
   - [GDEH075Z90](https://www.good-display.com/product/344.html) (7.5" 880x528 3-color)
   - [GDEY1248Z51](https://www.good-display.com/product/422.html) (12.48" 1304x984 3-color, requires [DESPI-C1248](https://www.e-paper-display.com/products_detail/productId=418.html) adapter)
   - [GDEY073D46](https://www.good-display.com/product/442.html) (7.3" 800x480 7-color, comes with DESPI-C73 adapter)
3. If you want to point the client to a custom server, change `kBaseUrl` in [`Client.cpp`](client/src/Client.cpp).
5. Compile and upload with `pio run -t upload`.

Follow the on-screen instructions to connect the client to a Wifi access point. The settings will be preserved across uploads and can be reset manually. See the [setup documentation](https://accent.ink/setup) for details.

## Server

The Accent server is built on [Google App Engine](https://cloud.google.com/appengine/) using the [Python 3 runtime in the standard environment](https://cloud.google.com/appengine/docs/standard/python3/runtime). See the [server control flow](server/README.md) for a high-level overview of the client code.

The database backend uses [Cloud Firestore](https://firebase.google.com/products/firestore/). User-specific data is stored in the `users` collection with each user identified by a key generated by the client to identify it.
   - `/users/<USER_KEY>/home` - The home address used for the local time, the weather, and the commute origin.
   - `/users/<USER_KEY>/work` - The work address used for the commute destination.
   - `/users/<USER_KEY>/travel_mode` - The commute [travel mode](https://developers.google.com/maps/documentation/directions/intro#TravelModes).
   - `/users/<USER_KEY>/schedule` - The content schedule.
   - `/users/<USER_KEY>/google_calendar_credentials` - The OAuth credentials for Google Calendar.

To populate the cross-user data after [setting up](https://firebase.google.com/docs/firestore/quickstart):
1. Obtain an API key for [Google Maps](https://cloud.google.com/maps-platform) and add it the `api_keys` collection under `/api_keys/google_maps/api_key`. Ensure that the [Maps Static API](https://console.cloud.google.com/apis/library/static-maps-backend.googleapis.com), [Directions API](https://console.cloud.google.com/apis/library/directions-backend.googleapis.com), [Geocoding API](https://console.cloud.google.com/apis/library/geocoding-backend.googleapis.com), [Maps Elevation API](https://console.cloud.google.com/apis/library/elevation-backend.googleapis.com), and [Time Zone API](https://console.cloud.google.com/apis/library/timezone-backend.googleapis.com) are all enabled and added to the key's restrictions. The [Cloud Vision API](https://console.cloud.google.com/apis/library/vision.googleapis.com) and [Google Calendar API](https://console.cloud.google.com/apis/library/calendar-json.googleapis.com) also need to be enabled, but they do not need a key.
2. Obtain an API key for [OpenWeather](https://openweathermap.org/guide) and add it in the `api_keys` collection under `/api_keys/open_weather/api_key`.
3. Obtain an [OAuth client ID](https://console.developers.google.com/apis/credentials) for the [Google Calendar API](https://developers.google.com/calendar/quickstart/python) with scope `https://www.googleapis.com/auth/calendar.readonly` in the OAuth consent screen. You will either need to make your OAuth app public or add your account to the list of test users. Configure the full `/oauth` URL of your App Engine app as an authorized redirect URI for the OAuth client. Write OAuth Client ID and Client Secret to the `client_id` and `client_secret` fields of the `google_calendar` document in the `oauth_clients` Firestore collection (`/oauth_clients/google_calendar`).

To test and deploy the server:
1. Install the [Google Cloud SDK](https://cloud.google.com/sdk/docs/), [create a project](https://cloud.google.com/resource-manager/docs/creating-managing-projects), and [authenticate with a service account](https://cloud.google.com/docs/authentication/getting-started).
2. Run `cd server && python3 -m venv venv && . venv/bin/activate`.
3. Run `pip install -r requirements.txt` (which also builds the [C extension](server/dithering_extension)).
4. Run the server locally with `export GOOGLE_CLOUD_PROJECT=$(gcloud config get-value project) && python main.py`.
5. Test the local server with:
   - [/hello/<USER_KEY>](http://localhost:8080/hello/<USER_KEY>) for the settings UI to edit user-specific data.
   - [/next?key=<USER_KEY>](http://localhost:8080/next?key=<USER_KEY>) for the time in milliseconds until the next schedule entry.
   - [/epd?key=<USER_KEY>](http://localhost:8080/epd?key=<USER_KEY>) for the currently scheduled client image used by the e-paper display.
   - [/gif?key=<USER_KEY>](http://localhost:8080/gif?key=<USER_KEY>) for a GIF version of the currently scheduled image for testing.
   - [/artwork?key=<USER_KEY>](http://localhost:8080/artwork?key=<USER_KEY>) to bypass the schedule and get the artwork image directly.
   - [/city?key=<USER_KEY>](http://localhost:8080/city?key=<USER_KEY>) to bypass the schedule and get the city image directly.
   - [/commute?key=<USER_KEY>](http://localhost:8080/commute?key=<USER_KEY>) to bypass the schedule and get the commute image directly.
   - [/calendar?key=<USER_KEY>](http://localhost:8080/calendar?key=<USER_KEY>) to bypass the schedule and get the calendar image directly.
   - [/everyone?key=<USER_KEY>](http://localhost:8080/everyone?key=<USER_KEY>) to bypass the schedule and get the everyone image directly.
   - [/wittgenstein?key=<USER_KEY>](http://localhost:8080/wittgenstein?key=<USER_KEY>) to bypass the schedule and get the wittgenstein image directly.
6. Deploy the server with `gcloud app deploy`.

## Frame

Files describing the Accent frame hardware include:
- A [Blender](https://www.blender.org/) project for simulating materials: [`frame.blend`](frame/frame.blend)
- A blueprint with basic dimensions: [`frame.pdf`](frame/frame.pdf)
- A [Shaper Origin](https://www.shapertools.com/) design: [`frame.svg`](frame/frame.svg)
- A [FreeCAD](https://www.freecadweb.org/) project: [`frame.FCStd`](frame/frame.FCStd)
- A G-code file for CNC milling: [`frame.gcode`](frame/frame.gcode)
- 3D models in STEP and STL formats: [`frame.step`](frame/frame.step) & [`frame.stl`](frame/frame.stl)
